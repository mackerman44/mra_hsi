---
title: "Habitat Suitability for Upper Salmon Subbasin Multiple Reach Assessments"
author:
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: mike.ackerman@merck.com
  - name: Richie Carmichael
    affiliation: Biomark, Inc.
    email: richard.carmichael@merck.com
  - name: Kevin See
    affiliation: Biomark, Inc.
    email: kevin.see@merck.com
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    theme: simplex
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
  bookdown::pdf_document2:
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks2.lua
    - --lua-filter=../templates/pagebreak.lua
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
  bookdown::word_document2: 
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
institute:
- biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
bibliography: references.bib
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# load knitr for markdown
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.path = "../output/figures/",
                      dpi = 300)
#options(tinytex.verbose = TRUE)
options(knitr.kable.NA = '-')
options(knitr.table.format = "pandoc")

# load packages for analysis
library(tidyverse)
library(ggpubr)
library(sf)
library(readxl)

# setwd('markdown')
```

# Introduction

The Bureau of Reclamation (BOR), Idaho Governor's Office of Species Conservation (OSC), and an interdisciplinary team of partners have assembled an Upper Salmon Assessment Team to complete biologic and geomorphic analyses to support future project identification, prioritization, and inform restoration design in the Upper Salmon Subbasin, Idaho. The biologic and geomorphic analyses are being lead by Biomark Inc. (Biomark) and Rio Applied Science and Engineering (Rio ASE), respectively. Past efforts from the team resulted in the development of a watershed-scale Integrated Rehabilitation Assessment (IRA; @IdOSC2019) in the Lemhi, Pahsimeroi, and Upper Salmon (Sawtooth Valley) watersheds. This initial phase of the project identified, generally, the "problem" by spatially quantifying capacity limitations for spring/summer Chinook salmon and summer run steelhead within a geomorphic context across these three watersheds. The second phase, termed the Multiple Reach Assessments (MRA), includes identifying appropriate and focused "solutions" to the acknowledged capacity problems within four valley segments: Upper Lemhi, Lower Lemhi, Lower Pahsimeroi, and Upper Salmon (Decker Flats). To achieve this goal, the team will collaboratively summarize existing and targeted physical habitat conditions relative to documented habitat needs for specific species and life stages, including discussion of high-quality habitat creation and maintenance to inform future rehabilitation actions.

In the IRA, it was determined that, for Chinook salmon, habitat capacity was limited to support presmolts during winter months, and to a slightly lesser degree, parr during summer months. Habitat was not found to be limiting for adult spawning. For steelhead, habitat capacity was identified as limiting for juvenile rearing, at least in the Pahsimeroi River; again, habitat was not found to be limiting for adult spawning. The available habitat capacity was estimated using quantile regression forest (QRF; IRA Appendix B) whereas habitat requirements were estimated for current escapement and recovery goals using a generalized capacity model (IRA Appendix C).

The goal of this document is to further assess existing conditions and evaluate the hydraulic suitability, particularly depth and velocity, of the four target valley segments to support select life stages of Chinook salmon and steelhead. By comparing depth and velocity suitability curves for Chinook salmon and steelhead, developed specifically for the Salmon River watershed [@Maret2006], to continuous modeled depths and velocities (supported by bathymetric Light Detection and Ranging; LiDAR) available for the four valley segments, we can further our understanding of how habitat, related specifically to hydraulics and the governing morphology, may be limiting recovery of Chinook salmon and steelhead in the Upper Salmon subbasin.  This information can help identify geomorphic reaches where existing depth and velocity may be limiting particular species and life stages, which could prove useful for project prioritization.The incorporation of a multitude of data sources (QRF, publication review, morphological analysis, hydraulic habitat suitability, etc.) allows for a robust assessment of the habitat and limiting factors for target species and life stages.

## Objective

Evaluate the composite suitability of geomorphic reaches in the upper Lemhi, lower Lemhi, lower Pahsimeroi, and upper Salmon (Decker Flat) valley segments based on modeled depth and velocity rasters supported by a multitude of LiDAR sampling events and sensors that incompass the study reaches. Composite suitability is evaluated for both Chinook salmon and steelhead at multiple life stages including, adult spawning and juvenile rearing at various discharge scenarios (see Table \@ref(tab:scenarios-tab)). The proportion of each geomorphic reach classified as simple, mixed, or complex is also provided for reference.

# Methods

We provide methods for calculating the composite (depth & velocity) suitability, by geomorphic reach, for a single scenario including steps to visualize results. A given scenario includes a watershed, species, life stage, and season combination. Here, we provide detailed methods for Scenario 1 in Table \@ref(tab:scenarios-tab): Lemhi River, Chinook salmon, juvenile summer (parr) rearing. The same methods were then applied across all scenarios utilizing the appropriate depth and velocity suitability curves (depending on species and adult versus juvenile) or differing input depth and velocity rasters (depending on season and estimated discharge). All scenarios evaluated are summarized in Table \@ref(tab:scenarios-tab). All data, scripts, outputs, and reports for this analysis can be found within the `mra_hsi` repository at https://github.com/mackerman44/mra_hsi. 

Detailed methods are as follows:

1. Raster .tifs containing depth and velocity values were imported into R [@R2019]. For the Lemhi River, raster pixels were 1m x 1m. As an example, for the Lemhi River, summer, low-flow scenario rasters were named D_Aug_All.tif and V_Aug_All.tif. Rasters were obtained from a previously funded study in the Lemhi River [@Tonina2019], where appropriate discharge volumes for hydraulic analysis were analyzed based on the Lemhi River Base Model [@Borden2016].

2. Import a polygon shapefile delineating the geomorphic reaches as defined in the IRA. The polygon shapefile is used to interrogate the depth and velocity .tifs to determine the geomorphic reach that each depth and velocity pixel falls within.

3. Read in the depth and velocity habitat suitability curves for Chinook salmon and steelhead from @Maret2006. Depth and velocity habitat suitability index (HSI) curves were available for both species for the adult spawning and juvenile rearing life stages. Functions to calculate the suitability for a given depth or velocity are available in the `mra_hsi` repository in the R/ directory. The [Habitat Suitability] section below shows the HSI curves used from @Maret2006.

4. Use the HSI curves to calculate the depth and velocity suitability for each raster pixel. The result is two new rasters each containing the calculated depth and velocity suitability values, respectively.

5. Calculate the composite suitability value for each raster pixel as the geometric mean of the depth and velocity suitability values. The result is a third composite suitability raster.

6. Extract the composite suitability values located within each geomorphic reach for each pixel into an R dataframe. The dataframe can then be used to summarize and visualize the composite suitability by geomorphic reach for the given watershed, species, life stage, and discharge scenario.

7. Write out the composite suitability values and geomorphic reaches for each pixel to a .csv. These results are all stored in the output/hsi_raw/ directory in the `mra_hsi` repository.

8. Calculate the total wetted area, weighted usable area, and normalized weighted usable area (i.e. hydraulic habitat suitability) for each species, life stage, and geomorphic reach. The total wetted area was calculated by counting the total number of pixels with a known area, that occur within the geomorphic reach and wetted area for a given scenario. The weighted usable area (WUA) was calculated by summing the composite suitability values of all pixels within that same area. And finally, the normalized weighted usable area i.e. hydraulic habitat suitability (HHS), was calculated by dividing the WUA by the total wetted area for each geomorphic reach.

Finally, we visualized the composite suitability values by valley segment, species, life stage (adult spawning, juvenile summer rearing, juvenile winter rearing), and geomorphic reach. Violin plots showing the distribution of composite suitability values are provided in the [Results] section. For reference, the proportion of each reach classified as simple, mixed, or complex is also provided. Further, we provide maps showing the mean of composite suitability values by species and life stage for each valley segment, and plots illustrating the weighted usable area and normalized weighted usable area for each individual scenario.

The resulting raster .tifs showing depth, velocity, and composite suitability are too large to store in a https://github.com/ repository, but are available from the authors upon request.

## Habitat Suitability

```{r hsi-curves}
hsi_df = read_csv("../data/hsi_curves/maret_hsi_curves_for_r.csv")
```

Figures \@ref(fig:chnk-hsi) and \@ref(fig:sthd-hsi) show HSI curves for Chinook salmon and steelhead from @Maret2006, respectively, used the analysis. These curves are used to calculate the depth or velocity suitability value for each pixel within a scenario. The composite suitability for a pixel is then calculated as the geometric mean of those values. As an example, using juvenile Chinook salmon and depth, if a pixel has a depth of 0m, that pixel is assigned a suitability of 0 whereas if the depth is greater than approximately 0.6m it is assigned a suitability of 1; a depth of 0.5m would be assigned a suitability of $\sim$ 0.7.

```{r chnk-hsi, fig.height = 4, fig.cap = "Suitability indices at varying depths and velocities for juvenile rearing and adult spawning for Chinook salmon from Maret et al. (2006)."}
# chinook hsi curves
chnk_hsi = hsi_df %>%
  filter(species == "Chinook") %>%
  ggplot(aes(x = value_m, y = si)) +
  geom_line(color = "royalblue3", size = 1.5) +
  coord_cartesian(xlim = c(0,2)) +
  theme_bw() +
  facet_grid(variable ~ life_stage) +
  labs(x = "Value (m | m/s)",
       y = "Suitability Index",
       title = "Chinook salmon")
chnk_hsi
#ggsave("../output/figures/chnk_hsi_curve.pdf", chnk_hsi)
```

```{r sthd-hsi, fig.height = 4, fig.cap = "Suitability indices at varying depths and velocities for juvenile rearing and adult spawning for steelhead from Maret et al. (2006)."}
sthd_hsi = hsi_df %>%
  filter(species == "Steelhead") %>%
  ggplot(aes(x = value_m, y = si)) +
  geom_line(color = "royalblue3", size = 1.5) +
  coord_cartesian(xlim = c(0,2)) +
  theme_bw() +
  facet_grid(variable ~ life_stage) +
  labs(x = "Value (m | m/s)",
       y = "Suitability Index",
       title = "Steelhead")
sthd_hsi
#ggsave("../output/figures/sthd_hsi_curve.pdf", sthd_hsi)
```

```{r hsi-p-prep}
## read in all of the HSI results
hsi_outputs = list.files(path = "../output/hsi_csvs/", pattern = "*.csv", full.names = T)
hsi_p = sapply(hsi_outputs, read_csv, simplify = F) %>%
  bind_rows(.id = "id") %>%
  dplyr::select(-c(id, X1)) %>%
  mutate(geo_reach = paste0("GR_", str_pad(sub(".*_", "", ID), 2, pad = "0"))) %>%
  dplyr::select(-ID) %>%
  dplyr::select(species, life_stage, season, geo_reach, everything()) %>%
  mutate(scenario = paste(life_stage, season, sep = "_")) %>%
  mutate(species = recode(species,
                          `chnk` = "Chinook",
                          `sthd` = "Steelhead")) %>%
  mutate(scenario = recode(scenario,
                           `juv_spr` = "Juvenile Spring Rearing",
                           `juv_sum` = "Juvenile Summer Rearing",
                           `juv_win` = "Juvenile Winter Rearing",
                           `spw_spr` = "Adult Spawning",
                           `spw_sum` = "Adult Spawning"))
```

```{r hsi-p-prep-rkm}
## read in all of the HSI results, as a spatial file, and then make non-spatial
rch_hsi = st_read("../output/hsi_rkm/hsi_rch_pts.gpkg")
hsi_rkm = rch_hsi %>%
  st_drop_geometry() %>%
  as_tibble() %>%
  rename(rkm = Reach)
```


## Scenarios

```{r scenarios-tab}
scenarios_tab = read_excel("../analysis/scenarios_to_run.xlsx") %>%
  assign("scenarios_df", ., inherits = T) %>%
  select(- `Date Completed`) %>%
  kable(align = 'c', caption = "Scenarios for which we evaluated the composite suitability (depth & velocity) within geomorphic reaches including the corresponding depth and velocity rasters used for each scenario.")
scenarios_tab
```

We evaluated `r nrow(scenarios_df)` scenarios in total which are summarized in Table \@ref(tab:scenarios-tab). For all summer scenarios, we used rasters from a discharge scenario representative of low flow conditions. In the case of the Lemhi and Pahsimeroi watersheds, all spring and winter scenarios used rasters from moderate to high flow conditions. Alternatively, for the Upper Salmon, winter scenarios were analyzed using a low-flow discharge. Finally, for the Upper Salmon, we added spring scenarios for juvenile rearing to evaluate high-flow conditions, as both summer and winter are typically low-flow in that watershed.

# Results

```{r comp-suit-data}
raw_outputs = list.files(path = "../output/hsi_raw/", pattern = "*.RData", full.names = T)
all_comp_suits = sapply(raw_outputs, function(x) mget(load(x)), simplify = T) %>%
  bind_rows() %>%
  mutate(geo_reach = paste0("GR_", str_pad(sub(".*_", "", ID), 2, pad = "0"))) %>%
  dplyr::select(-ID) %>%
  mutate(species = recode(species,
                          `chnk` = "Chinook",
                          `sthd` = "Steelhead"))
```

```{r comp-suit-data-rkm, eval = F}
raw_outputs = list.files(path = "../output/hsi_rkm/", pattern = "*.RData", full.names = T)
all_comp_suits = sapply(raw_outputs, function(x) mget(load(x)), simplify = T) %>%
  bind_rows() %>%
  mutate(species = recode(species,
                          `chnk` = "Chinook",
                          `sthd` = "Steelhead"))
```


Here, we provide a summary of the distribution (as violin plots) and mean (as maps) of composite suitability values by valley segment, species, life stage, and geomorphic reach. Raw outputs and raster .tifs of depth, velocity, and composite suitability values are available in the `mra_hsi` repository or from the authors.

## Upper Lemhi

Figure \@ref(fig:ul-plot) summarizes the composite hydraulic suitability within the Upper Lemhi valley segment to support Chinook salmon spawning and juvenile rearing (summer and winter) along with the proportion of each geomorphic reach classified as simple, mixed, or complex. In general, the hydraulic suitability for spawning, for both Chinook salmon and steelhead, is high, with a large number of pixels having a suitability of 1. Hydraulic suitability for steelhead juvenile rearing, during both the summer and winter scenarios, also tends to be high in the Upper Lemhi valley segment; whereas suitability for juvenile Chinook salmon rearing is low. Interestingly, geomorphic reach 01, the upstream-most reach starting at Leadore, contains more pixels with a suitability above 0 than all other geomorphic reaches for both summer and winter juvenile rearing.

```{r ul-plot, fig.height = 7, fig.cap = "Violin plots showing the distribution of composite suitability values (geometric mean of depth and velocity suitability) across geomorphic reaches in the Upper Lemhi valley segment. Results for both Chinook salmon and steelhead and for three lifestages (adult spawning, juvenile summer rearing, juvenile winter rearing) are shown. The bottom panel shows the proportion of each geometric reach classified as simple, mixed, or complex."}
# the geo reaches within the upper lemhi
ul_geos = c("GR_01", "GR_02", "GR_03", "GR_04",
            "GR_05", "GR_06", "GR_07", "GR_08")

# get upper lemhi data
ul_cs = all_comp_suits %>%
  filter(watershed == "lemh") %>%
  filter(geo_reach %in% ul_geos) %>%
  unite(scenario, life_stage, season, sep = "_") %>%
  mutate(scenario = recode(scenario,
                           `juv_sum` = "Juvenile Summer Rearing",
                           `juv_win` = "Juvenile Winter Rearing",
                           `spw_sum` = "Adult Spawning",
                           `spw_spr` = "Adult Spawning"))

# the violin plot
ul_vplot = ul_cs %>%
  ggplot(aes(x = geo_reach,
             y = value,
             fill = scenario)) +
  geom_violin(draw_quantiles = c(0.5),
              scale = "width") +
  scale_fill_brewer(palette = "Set3") +
  theme_bw() +
  facet_wrap(~ species, nrow = 2) +
  labs(x = "Geomorphic Reach",
       y = "Composite Suitability (Depth & Velocity)",
       fill = "Scenario",
       title = "Upper Lemhi") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# plot of geomorphic tier data
load("../output/geomorph/lemh_geomorph_summary.RData")
ul_tier_p = tier_summary %>%
  filter(Name %in% ul_geos) %>%
  ggplot(aes(x = Name, y = p_Geo_Tier, fill = Geo_Tier)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "p(Geomorphic Tier",
       fill = "Geomorphic Tier") +
  scale_fill_brewer(palette = "Accent") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# merge the violin and geomorphic tier plot
ul_p = ggarrange(plotlist = list(ul_vplot +
                                   theme(axis.text.x = element_blank(),
                                         legend.position = "top") +
                                   labs(x = NULL),
                                 ul_tier_p +
                                   theme(legend.position = "bottom")),
          nrow = 2,
          ncol = 1,
          heights = c(2, 1.25))
ul_p
#ggsave("../output/figures/ul_cs_plot.pdf", ul_p)
```

Figure \@ref(fig:ul-map) shows the mean composite hydraulic suitability of pixels by species, life stage, and geomorphic reach in the Upper Lemhi valley segment. The results parallel those of Figure \@ref(fig:ul-plot). Hydraulic suitability for spawning (both species) and for steelhead rearing tends to be high (red) whereas suitability for Chinook salmon rearing tend to be low (blue). 

```{r ul-map, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across geomorphic reaches for Chinook salmon and steelhead in the Upper Lemhi valley segment."}
# map by scenario
ul_cs_map = ul_cs %>%
  group_by(species, scenario, geo_reach) %>%
  summarise(mean = mean(value),
            median = median(value),
            n = n()) %>%
  left_join(st_read("../data/geomorph/geo_reaches/Lem_Poly_Label.shp") %>%
              mutate(Name = paste0("GR_", str_pad(sub(".*_", "", Name), 2, pad = "0"))),
            by = c("geo_reach" = "Name"))  %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(aes(fill = mean)) +
  geom_sf_label(aes(label = str_remove(geo_reach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  scale_fill_distiller(palette = "Spectral",
                       direction = 1) +
  theme_bw() +
  labs(fill = "Mean Composite Suitability") +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top")
ul_cs_map
#ggsave("../output/figures/ul_cs_map.pdf", ul_cs_map)
```

```{r ul-map-rkm, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across river kilometers for Chinook salmon and steelhead in the Upper Lemhi valley segment."}
# map by scenario
ul_cs_map2 = rch_hsi %>%
  filter(watershed == "lemh") %>%
  filter(Reach > 54) %>%
  ggplot() +
  geom_sf(aes(color = HHS)) +
  theme_bw() +
  # scale_color_viridis_c() +
  scale_color_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Hydraulic Habitat Suitability (HHS)") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  facet_grid(species ~ scenario)
ul_cs_map2
```


```{r ul-hsi-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and geomorphic reach for the upper Lemhi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = .0000075
ulem_hsi_p1 = hsi_p %>%
  filter(watershed == "lemh") %>%
  filter(geo_reach %in% ul_geos) %>%
  ggplot(aes(x = fct_rev(geo_reach))) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 1.1) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 1.1) +
  #geom_point(aes(y = WUA)) +
  #geom_bar(aes(y = HHS / coeff), stat = "identity", 
  #         alpha = 0.5, fill = "cornflowerblue") +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(title = "Upper Lemhi",
       x = "Geomorphic Reach",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
ulem_hsi_p1
```

```{r ul-hsi-rkm-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and river kilometer for the upper Lemhi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = hsi_rkm %>%
  filter(watershed == "lemh") %>%
  summarise_at(vars(WUA, HHS),
               list(max)) %>%
  mutate(coeff = HHS / WUA) %>%
  pull(coeff)

ulem_hsi_p = hsi_rkm %>%
  filter(watershed == "lemh") %>%
  filter(rkm > 54) %>%
  ggplot(aes(x = rkm)) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 0.5) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 0.5) +
  geom_smooth(aes(y = WUA, group = 1), 
              color = "royalblue4", 
              se = F,
              size = 1.1) +
  geom_smooth(aes(y = HHS / coeff, group = 1), 
              color = "orangered2", 
              se = F,
              size = 1.1) +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(title = "Upper Lemhi",
       x = "River Kilometer",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
ulem_hsi_p

```



## Lower Lemhi

Figure \@ref(fig:ll-plot) summarizes the composite hydraulic suitability within the Lower Lemhi valley segment to support Chinook salmon spawning and juvenile rearing (summer and winter) along with the proportion of each geomorphic reach classified as simple, mixed, or complex. Similar to the Upper Lemhi, hydraulic suitability for spawning in the Lower Lemhi is high; likewise, suitability for steelhead juvenile rearing is high (i.e., a large number of pixels have a composite suitability approaching or eual to 1). Suitability for juvenile Chinook salmon rearing in the Lower Lemhi is low. Coincidently, reaches with a high proportion classified as simple (e.g., GR_09-11) have a very high proportion of pixels with a suitability at 0; whereas the most complex reach, GR_15, has a much larger proportion of pixels landing higher in the violin distribution.

```{r ll-plot, fig.height = 7, fig.cap = "Violin plots showing the distribution of composite suitability values (geometric mean of depth and velocity suitability) across geomorphic reaches in the Upper Lemhi valley segment. Results for both Chinook salmon and steelhead and for three lifestages (adult spawning, juvenile summer rearing, juvenile winter rearing) are shown. The bottom panel shows the proportion of each geometric reach classified as simple, mixed, or complex."}
# geo reaches in the lower lemhi
ll_geos = c("GR_09", "GR_10", "GR_11", "GR_12",
            "GR_13", "GR_14", "GR_15", "GR_16")

# get lower lemhi data
ll_cs = all_comp_suits %>%
  filter(watershed == "lemh") %>%
  filter(geo_reach %in% ll_geos) %>%
  unite(scenario, life_stage, season, sep = "_") %>%
  mutate(scenario = recode(scenario,
                           `juv_sum` = "Juvenile Summer Rearing",
                           `juv_win` = "Juvenile Winter Rearing",
                           `spw_sum` = "Adult Spawning",
                           `spw_spr` = "Adult Spawning"))

# the violin plot
ll_vplot = ll_cs %>%
  ggplot(aes(x = geo_reach,
             y = value,
             fill = scenario)) +
  geom_violin(draw_quantiles = c(0.5),
              scale = "width") +
  scale_fill_brewer(palette = "Set3") +
  theme_bw() +
  facet_wrap(~ species, nrow = 2) +
  labs(x = "Geomorphic Reach",
       y = "Composite Suitability (Depth & Velocity)",
       fill = "Scenario",
       title = "Lower Lemhi") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# plot of geomorphic tier data
load("../output/geomorph/lemh_geomorph_summary.RData")
ll_tier_p = tier_summary %>%
  filter(Name %in% ll_geos) %>%
  ggplot(aes(x = Name, y = p_Geo_Tier, fill = Geo_Tier)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "p(Geomorphic Tier",
       fill = "Geomorphic Tier") +
  scale_fill_brewer(palette = "Accent") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# merge the violin and geomorphic tier plot
ll_p = ggarrange(plotlist = list(ll_vplot +
                                   theme(axis.text.x = element_blank(),
                                         legend.position = "top") +
                                   labs(x = NULL),
                                 ll_tier_p +
                                   theme(legend.position = "bottom")),
                 nrow = 2,
                 ncol = 1,
                 heights = c(2, 1.25))
ll_p
#ggsave("../output/figures/ll_cs_plot.pdf", ll_p)
```

Figure \@ref(fig:ll-map) shows the mean composite hydraulic suitability of pixels by species, life stage, and geomorphic reach in the Lower Lemhi valley segment. The Lower Lemhi map shows the same trends as the Upper Lemhi map. Hydraulic suitability for spawning and juvenile steelhead rearing is adequate; suitability for juvenile Chinook rearing is poor. Note that the upstream simple reaches (GR_09-11) are the deepest blue whereas the 'more' complex GR_15 seems to support higher calculated suitability (lighter blue) for juvenile Chinook rearing.

```{r ll-map, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across geomorphic reaches for Chinook salmon and steelhead in the Lower Lemhi valley segment."}
scenario_names = c(
  `Adult Spawning` = "Adult Spawning",
  `Juvenile Summer Rearing` = "Juvenile\nSummer Rearing",
  `Juvenile Winter Rearing` = "Juvenile\nWinter Rearing"
)

# map by scenario
ll_cs_map = ll_cs %>%
  group_by(species, scenario, geo_reach) %>%
  summarise(mean = mean(value),
            median = median(value),
            n = n()) %>%
  left_join(st_read("../data/geomorph/geo_reaches/Lem_Poly_Label.shp") %>%
              mutate(Name = paste0("GR_", str_pad(sub(".*_", "", Name), 2, pad = "0"))),
            by = c("geo_reach" = "Name"))  %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(aes(fill = mean)) +
  geom_sf_label(aes(label = str_remove(geo_reach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  scale_fill_distiller(palette = "Spectral",
                       direction = 1) +
  theme_bw() +
  labs(fill = "Mean Composite Suitability") +
  facet_grid(species ~ scenario,
             labeller = labeller(scenario = as_labeller(scenario_names))) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top")
ll_cs_map
#ggsave("../output/figures/ll_cs_map.pdf", ll_cs_map)
```

```{r ll-map-rkm, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across river kilometers for Chinook salmon and steelhead in the Lower Lemhi valley segment."}
ll_cs_map2 = rch_hsi %>%
  filter(watershed == "lemh") %>%
  filter(Reach <= 54) %>%
  ggplot() +
  geom_sf(aes(color = HHS)) +
  theme_bw() +
  # scale_color_viridis_c() +
  scale_color_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Hydraulic Habitat Suitability (HHS)") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  facet_grid(species ~ scenario)
ll_cs_map2
```

```{r ll-hsi-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and geomorphic reach for the lower Lemhi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = .0000075
llem_hsi_p1 = hsi_p %>%
  filter(watershed == "lemh") %>%
  filter(geo_reach %in% ll_geos) %>%
  ggplot(aes(x = fct_rev(geo_reach))) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 1.1) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 1.1) +
  #geom_point(aes(y = WUA)) +
  #geom_bar(aes(y = HHS / coeff), stat = "identity", 
  #         alpha = 0.5, fill = "cornflowerblue") +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(title = "Lower Lemhi",
       x = "Geomorphic Reach",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
llem_hsi_p1
```

```{r ll-hsi-rkm-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and river kilometer for the lower Lemhi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = hsi_rkm %>%
  filter(watershed == "lemh") %>%
  summarise_at(vars(WUA, HHS),
               list(max)) %>%
  mutate(coeff = HHS / WUA) %>%
  pull(coeff)

llem_hsi_p = hsi_rkm %>%
  filter(watershed == "lemh") %>%
  filter(rkm <= 54) %>%
  ggplot(aes(x = rkm)) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 0.5) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 0.5) +
  geom_smooth(aes(y = WUA, group = 1), 
              color = "royalblue4", 
              se = F,
              size = 1.1) +
  geom_smooth(aes(y = HHS / coeff, group = 1), 
              color = "orangered2", 
              se = F,
              size = 1.1) +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(title = "Lower Lemhi",
       x = "River Kilometer",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
llem_hsi_p

```

## Pahsimeroi

Figure \@ref(fig:ph-plot) summarizes the composite hydraulic suitability within the Pahsimeroi valley segment to support Chinook salmon spawning and juvenile rearing (summer and winter) along with the proportion of each geomorphic reach classified as simple, mixed, or complex. Composite suitability for spawning in the Lower Pahsimeroi tends to be low for both species, especially in the uppermost geomorphic reaches, GR_08 and GR_09.  Given the relationships in Figures \@ref(fig:chnk-hsi) and \@ref(fig:sthd-hsi) it can be assumed that this is can be attributed to higher than suitable velocities. Suitability for juvenile Chinook rearing is low within the Lower Pahsimeroi valley segment (similiar to the Lemhi); however, suitability for juvenile steelhead rearing is also low, most notable in GR_08 and GR_09. The mean suitability for steelhead juvenile rearing in those reaches is near 0.35 (shown in the violin plots); lower than in the Lemhi.

```{r ph-plot, fig.height = 7, , fig.cap = "Violin plots showing the distribution of composite suitability values (geometric mean of depth and velocity suitability) across geomorphic reaches in the Lower Pahsimeroi valley segment. Results for both Chinook salmon and steelhead and for three lifestages (adult spawning, juvenile summer rearing, juvenile winter rearing) are shown. The bottom panel shows the proportion of each geometric reach classified as simple, mixed, or complex."}
# get pahsimeroi data
ph_cs = all_comp_suits %>%
  filter(watershed == "pahs") %>%
  unite(scenario, life_stage, season, sep = "_") %>%
  mutate(scenario = recode(scenario,
                           `juv_sum` = "Juvenile Summer Rearing",
                           `juv_win` = "Juvenile Winter Rearing",
                           `spw_sum` = "Adult Spawning",
                           `spw_spr` = "Adult Spawning"))

# the violin plot
ph_vplot = ph_cs %>%
  ggplot(aes(x = geo_reach,
             y = value,
             fill = scenario)) +
  geom_violin(draw_quantiles = c(0.5),
              scale = "width") +
  scale_fill_brewer(palette = "Set3") +
  theme_bw() +
  facet_wrap(~ species, nrow = 2) +
  labs(x = "Geomorphic Reach",
       y = "Composite Suitability (Depth & Velocity)",
       fill = "Scenario",
       title = "Pahsimeroi") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# plot of geomorphic tier data
load("../output/geomorph/pahs_geomorph_summary.RData")
ph_tier_p = tier_summary %>%
  ggplot(aes(x = Name, y = p_Geo_Tier, fill = Geo_Tier)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "p(Geomorphic Tier",
       fill = "Geomorphic Tier") +
  scale_fill_brewer(palette = "Accent") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# merge the violin and geomorphic tier plot
ph_p = ggarrange(plotlist = list(ph_vplot +
                                   theme(axis.text.x = element_blank(),
                                         legend.position = "top") +
                                   labs(x = NULL),
                                 ph_tier_p +
                                   theme(legend.position = "bottom")),
                 nrow = 2,
                 ncol = 1,
                 heights = c(2, 1.25))
ph_p
#ggsave("../output/figures/ph_cs_plot.pdf", ph_p)
```

Figure \@ref(fig:ph-map) shows the mean composite hydraulic suitability of pixels by species, life stage, and geomorphic reach in the Pahsimeroi valley segment. The results are similar to Figure \@ref(fig:ph-map). Hydraulic suitability for spawning is lower in the Lower Pahsimeroi valley segment than it is in either of the Lemhi River valley segments, presumably due to increased velocities (although, this would need to be verified by closer inspection of velocity .tifs or suitability values and/or empirical velocity data). Also, suitability for juvenile steelhead rearing is lower than in the Lemhi, at least for GR_08 and GR_09. Suitability for juvenile Chinook rearing also remains low.

```{r ph-map, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across geomorphic reaches for Chinook salmon and steelhead in the Lower Pahsimeroi valley segment."}
# map by scenario
ph_cs_map = ph_cs %>%
  group_by(species, scenario, geo_reach) %>%
  summarise(mean = mean(value),
            median = median(value),
            n = n()) %>%
  left_join(st_read("../data/geomorph/geo_reaches/Pah_Poly_Label.shp") %>%
              rename(Name = GeoReach) %>%
              mutate(Name = str_replace(Name, "-", "_")) %>%
              mutate(Name = paste0("GR_", str_pad(sub(".*_", "", Name), 2, pad = "0"))),
            by = c("geo_reach" = "Name"))  %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(aes(fill = mean)) +
  geom_sf_label(aes(label = str_remove(geo_reach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +  
  scale_fill_distiller(palette = "Spectral",
                       direction = 1) +
  theme_bw() +
  labs(fill = "Mean Composite Suitability") +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top")
ph_cs_map
#ggsave("../output/figures/ph_cs_map.pdf", ph_cs_map)
```

```{r ph-map-rkm, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across river kilometers for Chinook salmon and steelhead in the Lower Pahsimeroi valley segment."}
ph_cs_map2 = rch_hsi %>%
  filter(watershed == "pahs") %>%
  ggplot() +
  geom_sf(aes(color = HHS)) +
  theme_bw() +
  # scale_color_viridis_c() +
  scale_color_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Hydraulic Habitat Suitability (HHS)") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  facet_grid(species ~ scenario)
ph_cs_map2
```

```{r ph-hsi-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and geomorphic reach for the Pahsimeroi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = .000001
pahs_hsi_p1 = hsi_p %>%
  filter(watershed == "pahs") %>%
  ggplot(aes(x = fct_rev(geo_reach))) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 1.1) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 1.1) +
  #geom_point(aes(y = WUA)) +
  #geom_bar(aes(y = HHS / coeff), stat = "identity", 
  #         alpha = 0.5, fill = "cornflowerblue") +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
pahs_hsi_p1
```

```{r ph-hsi-rkm-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and river kilometer for the Pahsimeroi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = hsi_rkm %>%
  filter(watershed == "pahs") %>%
  summarise_at(vars(WUA, HHS),
               list(max)) %>%
  mutate(coeff = HHS / WUA) %>%
  pull(coeff)

pahs_hsi_p = hsi_rkm %>%
  filter(watershed == "pahs") %>%
  ggplot(aes(x = rkm)) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 0.5) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 0.5) +
  geom_smooth(aes(y = WUA, group = 1), 
              color = "royalblue4", 
              se = F,
              size = 1.1) +
  geom_smooth(aes(y = HHS / coeff, group = 1), 
              color = "orangered2", 
              se = F,
              size = 1.1) +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(title = "Pahsimeroi",
       x = "River Kilometer",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
pahs_hsi_p

```

## Upper Salmon

Figure \@ref(fig:us-plot) summarizes the composite hydraulic suitability within the Upper Salmon valley segment to support Chinook salmon spawning and juvenile rearing (summer and winter) along with the proportion of each geomorphic reach classified as simple, mixed, or complex. Results in the Upper Salmon valley segment diverge from those in the Lemhi and Pahsimeroi. Composite suitability for adult spawning is mixed, although for both species there appears to be a fair distribution of pixels near 1; for Chinook, suitability seems to be better in the downstream reaches (GR_07-10). Suitability for juvenile steelhead rearing tends to be high among reaches, although reaches GR_05 and GR_06 have the lowest composite suitablity values of all the reaches. Composite suitability for juvenile Chinook salmon (mean < 0.5 in all geomorphic reaches) is much higher than observed in the Lemhi or Pahsimeroi, at least for the summer and winter scenarios (spring high-flow suitability is still low). Further, juvenile Chinook rearing suitability is consistently > 0.3 among all geomorphic reaches. This is likely attributed to geomorphic reaches in the Upper Salmon valley segment consistently having a higher proportion of geomorphic reaches classified as complex.

```{r us-plot, fig.height = 7, , fig.cap = "Violin plots showing the distribution of composite suitability values (geometric mean of depth and velocity suitability) across geomorphic reaches in the Upper Salmon (Decker Flat) valley segment. Results for both Chinook salmon and steelhead and for four lifestages (adult spawning, juvenile spring rearing, juvenile summer rearing, juvenile winter rearing) are shown. The bottom panel shows the proportion of each geometric reach classified as simple, mixed, or complex."}
# get upper salmon data
us_cs = all_comp_suits %>%
  filter(watershed == "upsa") %>%
  unite(scenario, life_stage, season, sep = "_") %>%
  mutate(scenario = recode(scenario,
                           `juv_spr` = "Juvenile Spring Rearing",
                           `juv_sum` = "Juvenile Summer Rearing",
                           `juv_win` = "Juvenile Winter Rearing",
                           `spw_sum` = "Adult Spawning",
                           `spw_spr` = "Adult Spawning"))

# the violin plot
us_vplot = us_cs %>%
  ggplot(aes(x = geo_reach,
             y = value,
             fill = scenario)) +
  geom_violin(draw_quantiles = c(0.5),
              scale = "width") +
  scale_fill_brewer(palette = "Set3") +
  theme_bw() +
  facet_wrap(~ species, nrow = 2) +
  labs(x = "Geomorphic Reach",
       y = "Composite Suitability (Depth & Velocity)",
       fill = "Scenario",
       title = "Upper Salmon") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# plot of geomorphic tier data
load("../output/geomorph/upsa_geomorph_summary.RData")
us_tier_p = tier_summary %>%
  filter(!Name == "GR_NA") %>%
  ggplot(aes(x = Name, y = p_Geo_Tier, fill = Geo_Tier)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = "p(Geomorphic Tier",
       fill = "Geomorphic Tier") +
  scale_fill_brewer(palette = "Accent") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

# merge the violin and geomorphic tier plot
us_p = ggarrange(plotlist = list(us_vplot +
                                   theme(axis.text.x = element_blank(),
                                         legend.position = "top") +
                                   labs(x = NULL),
                                 us_tier_p +
                                   theme(legend.position = "bottom")),
                 nrow = 2,
                 ncol = 1,
                 heights = c(2, 1.25))
us_p
#ggsave("../output/figures/us_cs_plot.pdf", us_p)
```

Figure \@ref(fig:us-map) shows the mean composite hydraulic suitability of pixels by species, life stage, and geomorphic reach in the Upper Salmon valley segment. Spawning suitability appears to be lower in the Upper Salmon than in the Lemhi and Pahsimeroi; however, all reaches still appear to have areas (pixels) with high suitability. Suitability for steelhead rearing appears to be moderate. Finally, although still not high, composite suitability for juvenile Chinook salmon rearing in the Upper Salmon appears to be much greater than in the Lemhi or Pahsimeroi.

```{r us-map, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across geomorphic reaches for Chinook salmon and steelhead in the Upper Salmon (Decker Flat) valley segment."}
# map by scenario
us_cs_map = us_cs %>%
  group_by(species, scenario, geo_reach) %>%
  summarise(mean = mean(value),
            median = median(value),
            n = n()) %>%
  ungroup() %>%
  mutate(scenario = recode(scenario,
                           "Adult Spawning" = "Adult\nSpawning",
                           "Juvenile Spring Rearing" = "Juvenile\nSpring\nRearing",
                           "Juvenile Summer Rearing" = "Juvenile\nSummer\nRearing",
                           "Juvenile Winter Rearing" = "Juvenile\nWinter\nRearing")) %>%
  left_join(st_read("../data/geomorph/geo_reaches/US_Poly_Label.shp") %>%
              select(GeoReach, geometry) %>%
              rename(Name = GeoReach) %>%
              mutate(Name = str_replace(Name, "-", "_")) %>%
              mutate(Name = paste0("GR_", str_pad(sub(".*_", "", Name), 2, pad = "0"))),
            by = c("geo_reach" = "Name"))  %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(aes(fill = mean)) +
  geom_sf_label(aes(label = str_remove(geo_reach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  scale_fill_distiller(palette = "Spectral",
                       direction = 1) +
  theme_bw() +
  labs(fill = "Mean Composite Suitability") +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top")
us_cs_map
#ggsave("../output/figures/us_cs_map.pdf", us_cs_map)
```

```{r us-map-rkm, results = 'hide', fig.cap = "Map showing the mean composite suitability by life stage and across river kilometers for Chinook salmon and steelhead in the Upper Salmon (Decker Flat) valley segment."}
us_cs_map2 = rch_hsi %>%
  filter(watershed == "upsa") %>%
  mutate(scenario = recode(scenario,
                           "Adult Spawning" = "Adult\nSpawning",
                           "Juvenile Spring Rearing" = "Juvenile\nSpring\nRearing",
                           "Juvenile Summer Rearing" = "Juvenile\nSummer\nRearing",
                           "Juvenile Winter Rearing" = "Juvenile\nWinter\nRearing")) %>%
  ggplot() +
  geom_sf(aes(color = HHS)) +
  theme_bw() +
  # scale_color_viridis_c() +
  scale_color_distiller(palette = "Spectral",
                       direction = 1,
                       name = "Hydraulic Habitat Suitability (HHS)") +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  facet_grid(species ~ scenario)
us_cs_map2
```

```{r us-hsi-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and geomorphic reach for the upper Salmon River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = .000002
upsa_hsi_p1 = hsi_p %>%
  filter(watershed == "upsa") %>%
  ggplot(aes(x = fct_rev(geo_reach))) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 1.1) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 1.1) +
  #geom_point(aes(y = WUA)) +
  #geom_bar(aes(y = HHS / coeff), stat = "identity", 
  #         alpha = 0.5, fill = "cornflowerblue") +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(x = "Geomorphic Reach",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
upsa_hsi_p1
```

```{r us-hsi-rkm-p, fig.cap = "The weighted usable area (WUA) shown as points and on the primary axis and the hydraulic habitat suitability (HHS) i.e. normalized WUA shown as bars and on the secondary axis by species, life stage, and river kilometer for the Pahsimeroi River valley segment. The HHS is the normalized by dividing the weighted usable area for each reach by the total area of that reach."}
coeff = hsi_rkm %>%
  filter(watershed == "upsa") %>%
  summarise_at(vars(WUA, HHS),
               list(max)) %>%
  mutate(coeff = HHS / WUA) %>%
  pull(coeff)

upsa_hsi_p = hsi_rkm %>%
  filter(watershed == "upsa") %>%
  ggplot(aes(x = rkm)) +
  geom_line(aes(y = WUA, group = 1), color = "royalblue4", size = 0.5) +
  geom_line(aes(y = HHS / coeff, group = 1), color = "orangered2", size = 0.5) +
  geom_smooth(aes(y = WUA, group = 1), 
              color = "royalblue4", 
              se = F,
              size = 1.1) +
  geom_smooth(aes(y = HHS / coeff, group = 1), 
              color = "orangered2", 
              se = F,
              size = 1.1) +
  scale_y_continuous(sec.axis = sec_axis(~. * coeff,
                                         name = "Hydraulic Habitat Suitability (HHS)",
                                         breaks = seq(0, 1, by = 0.25))) +
  theme_bw() +
  labs(title = "Upper Salmon",
       x = "River Kilometer",
       y = expression("Weighted Usable Area (WUA) m"^{2})) +
  facet_grid(species ~ scenario) +
  theme(axis.text.x = element_text(angle = -45, hjust = -0.05, vjust = 0.9, size = 8),
        axis.title.y = element_text(colour = "royalblue4"),
        axis.title.y.right = element_text(colour = "orangered2"))
upsa_hsi_p

```

# Discussion

## Spawning

Of the three watersheds and four valley segments evaluated, the Pahsimeroi appears to have the lowest suitability for both Chinook and steelhead spawning where the majority of the model domain for reaches GR_08 and GR_09 illustrating a 0 composite suitability, but as you move downstream in the watershed to GR_10, the suitability is much improved. Hydraulic habitat does not appear to be limiting for spawning for Chinook salmon or steelhead within the two Lemhi valley segments analyzed. The Upper Salmon valley segment has mixed suitability results; primarily where there is increasing "complex" geomorphic character, the number of suitable grid cells also increases. Reaches GR_04, GR_05, and GR_06 appear to have the lowest quality spawning habitat for both steelhead and Chinook salmon within the Upper Salmon valley segment. It is likely that the decrease in "complex" geomorphic character is related to an increase in velocity, resulting in unsuitable spawning due to velocities being too high. This corroborates the findings in the IRA [@IdOSC2019] where they found that spawning habitat capacity was not limiting to support contemporary escapement estimates in those areas or reach recovery goals. The results illustrated here provide an additional line of evidence; these valley segments support adequate spawning suitability based on hydraulics (depth, velocity) and spawning conditions do not appear to be limiting population recovery of the two species of interest. Although out of the scope of this document, it may be possible that the incubation or emergence life stages following spawning may or may not be limited by the habitat. Fine sedimentation in the target watersheds and in the Upper Salmon Subbasin as a whole remains a concern as it can reduce oxygenation of eggs and affect hyporheic flow, reducing egg survival.

## Juvenile rearing

### Steelhead

For steelhead, hydraulic habitat quality and quantity does not appear to be limiting for either summer or winter rearing within the upper and lower Lemhi; the majority of composite suitability values in grid cells fall at or above 0.9. The majority of stream length in the upper Lemhi is characterized as "Complex", but geomorphic results within the lower Lemhi appear to be the opposite, where the stream length is characterized as "Mixed" or "Simplified" for most of the valley segment. Results in the Upper Salmon are mixed, with much of the modeling domain with composite suitability values at or above 0.5 for summer, winter, and spring rearing. As you move downsream within the valley segment, the percentage of "Complex" geomorphic type decreases, but that does not appear to be driving a parallel reduction in juvenile steelhead rearing. The majority of juvenile spring rearing is near or at 0 composite suitability, but this is expected during high flows where the mainstem channel would have extrememly high velocities during spring snow runoff. The Pahsimeroi river had the lowest amount and quality of suitable juvenile rearing for both summer and winter scenarios in reach GR_08, but reaches GR_09 and GR_10 illustrate similar results to the Lemhi River with many of the grid cell composite suitability falling at or above 0.9. As the percentage of "Complex" geomorphic character increases within the Pahsimeroi River, the amount of suitable rearing habitat also appears to increase.

Modeled depths and velocities within the scenarios evaluated appear to be largely within the ranges considered suitable for steelhead rearing in the target watersheds. An exception is the GR_08 and GR_09 reaches in the lower Pahsimeroi valley segment where mean composite suitabilities fall below 0.5 (Figure \@ref(fig:ph-plot)), presumably due to high velocities in those locations. This area of the Pahsimeroi has the lowest mean hydraulic habitat suitability for all reaches and steelhead scenarios. In addition, there are two geomorphic reaches in the Upper Salmon River (GR_05 and GR_06) where mean composite suitability is decreased; however, mean composites there remain above 0.5 (Figure \@ref(fig:us-plot)). Further evaluation of the depth and velocity suitability values or .tifs in those geomorphic reaches would reveal whether high velocities or low depth (or both) are the culprit for decreased hydraulic suitabilties in those reaches.

### Chinook salmon

Hydraulic habitat suitability appears to be poor for juvenile Chinook salmon rearing in all three watersheds with the exception being the Upper Salmon valley segment during the summer and winter scenarios evaluated, alhtough mean composite suitabilty values there remain below 0.5 (Figure \@ref(fig:us-plot)). Compsite suitability values in the Lemhi and Pahsimeroi were largely near 0 with few exceptions (Figures \@ref(fig:ul-plot), \@ref(fig:ll-plot), and \@ref(fig:ph-plot)). These results corroborate findings in the IRA where Chinook salmon juvenile rearing was identified as the most limited species and life stage combination evaluated there. These results provide an additional line of evidence that a lack of suitable habitat for juvenile Chinook salmon is a concern in the Upper Salmon Subbasin. It is of interest that areas of suitable modeled depths and velocities were identified among geomorphic reaches in the Upper Salmon valley segment (at least for the summer and winter low-flows); the resulting depth, velocity, and composite suitability .tifs for those reaches could be further inspected to identify characteristics that allow for suitable depths and velocities to describe target conditions. With that said, composite suitabilities in the spring high-flow scenario evaluated in the Upper Salmon subbasin were poor, which is to be expected.

## Conclusions

This document provides a baseline of existing hydraulic conditions for the 4 MRA valley segments of interest in addition to the entirety of the available LiDAR and numerical modelling domain within the Upper Salmon Subbasin. Summaries provided here could be used, if desired, for project prioritization. The raw composite suitability values are available in the `mra_hsi` repository at https://github.com/mackerman44/mra_hsi and the resulting depth, velocity, and composite suitability raster .tifs are available from the authors (and may be transferred to the OSC FTP). Further, inspection of areas with high composite suitabilities for a given species by life stage combination could be used to identify characteristics that may provide relatively greater amounts and quality of depths and velocities, and perhaps, be used to describe relative target condtions. All of these habitat suitability results should be considered relative when trying to evaluate target conditions because the baseline of target conditions, given contemporary habitat, may still be poorer than habitat conditions available before anthropogenic influence. Results provided here can be used in the upcoming MRA reports to help describe existing and target conditions.

# Literature Cited

<!-- Borden, C. (2016). Lemhi River Basin Model Supporting Documentation. Centered Consulting International report for the State of Idaho Office of Species Conservation, March 2016, 80 p. -->

<!-- Idaho OSC Team (Idaho Governor’s Office of Species Conservation and partners). 2019. Upper Salmon Subbasin Habitat Integrated Rehabilitation Assessment. Assessment prepared for and with the U.S. Department of the Interior, Bureau of Reclamation. June 2019. 625 pp. -->

<!-- Maret, T.R, J.E. Horness, and D.S. Ott. 2006. Instream Flow Characterization of Upper Salmon River Basin Streams, Central Idaho, 2005. Scientific Investigations Report 2006-5230. U.S. Department of the Interior, U.S. Geological Survey. Prepared in cooperation with the Bureau of Reclamation. 110 p. -->

<!-- R Core Team. 2017. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/ -->

<!-- Tonina, D., McKean, J.A., Benjankar, R.M., Wright, W., Goode, J.R., Chen, Q., Reeder, W.J., Carmichael, R.A., and Edmondson, M.R. 2018. Mapping river bathymetries: evaluating topobathymetric LiDAR survey. Earth Surf. Process. Landforms. doi:10.1002/esp.4513. -->
