---
title: "Tagging Rate at Lower Granite Dam"
author:
- Kevin See:
    correspondence: yes
    email: Kevin.See@biomark.com
    institute: biomark
- Mike Ackerman:
    correspondence: yes
    email: Mike.Ackerman@biomark.com
    institute: biomark
- Kyle Meier:
    institute: biomark
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::word_document2: 
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
  bookdown::pdf_document2:
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks2.lua
    - --lua-filter=../templates/pagebreak.lua
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
  bookdown::html_document2:
    theme: simplex
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
institute:
- biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
options(knitr.kable.NA = '-')
options(knitr.table.format = "pandoc")

# load packages for analysis
library(tidyverse)
library(magrittr)
library(readxl)
library(scales)
library(janitor)
library(sf)
library(ggrepel)

theme_set(theme_bw())
# setwd('trap_rate')
```

# Introduction

We are interested in determining the relationship between the number of PIT tags implanted in adults at Lower Granite Dam (LGR) and the precision of abundance estimates at the technical recovery team (TRT) population scale for Snake River Basin spring/summer Chinook salmon ESU and steelhead DPS. The number of PIT tags to implant at LGR can then be used to make inferences about trapping and tagging rates. We also consider the precision of sex and total age specific abundance estimates, which are necessary for estimating population productivity (e.g., recruits per spawner/female). Finally, we consider a theoretical scenario in which the detection efficiencies across the basin were increased by 5-20%.

```{r read_in_est}
AbundanceFolder = '../../SnakeBasinFishStatus/Abundance_results' # for processed files

# abundance estimates
pop_est = c('Chinook', 'Steelhead') %>%
  as.list() %>%
  rlang::set_names() %>%
  map_df(.f = function(x) {
    read_excel(paste0(AbundanceFolder, '/LGR_AllSummaries_', x, '.xlsx'),
               sheet = 'Pop Total Esc')
  }) %>%
  filter(!is.na(n_tags)) %>%
  mutate_at(vars(spawn_yr:TRT),
            list(as.factor)) %>%
  mutate_at(vars(cv),
            list(as.numeric)) %>%
  rename(Species = species)

# detection probability estimates
p_est = c('Chinook', 'Steelhead') %>%
  as.list() %>%
  rlang::set_names() %>%
  map_df(.f = function(x) {
    read_excel(paste0(AbundanceFolder, '/LGR_AllSummaries_', x, '.xlsx'),
               'Node Detect Eff')
  }) %>%
  # filter(!is.na(n_tags)) %>%
  mutate_at(vars(spawn_yr:Node),
            list(as.factor)) %>%
  mutate_at(vars(cv),
            list(as.numeric)) %>%
  rename(Species = species)


```

```{r read_in_sites}
# which sites are attached to which TRT populations?
site_pop = c('Chinook', 'Steelhead') %>%
  as.list() %>%
  rlang::set_names() %>%
  map_df(.id = 'Species',
         .f = function(x) read_csv(paste0('../data/Site_TRT_', x, '.csv')))

# attach populations to site detection probabilities
p_est %<>%
  left_join(site_pop %>%
              select(Species, Node, TRT, POP_NAME, MPG) %>%
              distinct())

# read in all Snake Basin populations
sb_pops = read_excel('../data/Snake_River_TRT_Populations.xlsx') %>%
  mutate(TRT = recode(TRT,
                      "IRMMT-s" = "IRMAI-s"))

# which populations don't have detection infrastructure on them at all?
no_monitor_pops = sb_pops %>%
  anti_join(p_est %>%
              select(Species, TRT) %>%
              distinct())

```

```{r eval = F}
# this populations have a single detection site
single_site_pops = site_pop %>%
  group_by(Species, TRT, POP_NAME) %>%
  summarise(n_sites = n_distinct(SiteID)) %>%
  arrange(Species, n_sites) %>%
  filter(n_sites == 1) %>%
  left_join(site_pop %>%
              select(Species, TRT, SiteID:SiteName) %>%
              distinct()) %>%
  select(-n_sites)

single_site_det = single_site_pops %>%
  left_join(site_pop) %>%
  select(Species, SiteID, SiteType, Node, TRT, POP_NAME, MPG) %>%
  left_join(p_est) %>%
  filter(n_tags > 0,
         sd > 0) %>%
  select(Species:estimate) %>%
  mutate(loc = if_else(grepl('A0$', Node),
                             'upstrm',
                             'dwnstrm')) %>%
  select(Species:estimate, loc,
         -Node, -n_tags) %>%
  spread(loc, estimate) %>%
  mutate(p_all = 1 - ((1-dwnstrm) * (1 - upstrm)))

```

# Methods

First, we wanted to leverage results based on empirical data from the inception of the PIT tagging program at LGR (2010) to the present. We started by gathering data on all estimates that have been made for population abundance at the TRT spacial scale, and examining the relationship between the number of tags observed in each population, and the coefficient (CV) of the estimate. We fit a model on the semi-log scale:

$$
\begin{aligned}
\text{CV} &\sim e^{a + b * n_{tags}} \\
\log(\text{CV}) &\sim a + b * n_{tags} \\
\end{aligned}
$$
the log-log scale:

$$
\begin{aligned}
\text{CV} &\sim a * n_{tags}^{b} \\
\log(\text{CV}) &\sim \log(a) + b * \log(n_{tags})
\end{aligned}
$$


and, in addition, a more flexible version using a loess spline. We were interested in how many tags would need to be detected within each TRT population, and using each model, to predict a CV of $\leq$ 0.15. Similarly, we examined the relationship between the proportion of all tags that were deployed at LGR that were detected within each population, and the CV of the population estimate. 

The previous provides information on the number of tags, or the proportion of all deployed tags, returning to a population necessary to achieve a precise abundance estimate. We then need to determine how many tags would need to be deployed at LGR to achieve that minimum number of tags to each TRT population to achieve that level of precision in our abundance estimates. To do this, we started by looking at the proportion of tags deployed at LGR that were detected in each TRT population by year, and then averaged across years. Finally, given the minimum number of detections required to achieve a precise abundance estimate, we estimated the number of total tags needed to be deployed at LGR that would be expected to result in the minimum number of detections for that TRT population. We can also predict for a given number of tags deployed at LGR whether there will be sufficient detections in each TRT population to achieve a reasonably precise abundance estimate.

```{r}
# the number of tags deployed by species and year at LGR
tags_deploy = crossing(Species = c('Chinook', 'Steelhead'),
                       spawn_yr = c(2010:2019)) %>%
  filter(!(Species == 'Chinook' & spawn_yr == 2019)) %>%
  mutate(tot_tags = map2_int(.x = Species,
                             .y = spawn_yr,
                             .f = function(x, y) {
                               load(paste0('../../SnakeBasinFishStatus/DABOM_results/LGR_DABOM_',x,'_',y,'.rda'))
                               return(nrow(proc_list$ValidTrapData))
                             }))

# proportion of all tags seen in one of the TRT populations
prop_det_df = tags_deploy %>%
              left_join(pop_est %>%
                          group_by(spawn_yr, Species) %>%
                          summarise(tot_tags_det = sum(n_tags)) %>%
                          ungroup() %>%
                          mutate_at(vars(spawn_yr),
                                    list(~ as.integer(as.character(.))))) %>%
              mutate(prop_det = tot_tags_det / tot_tags)


min_yr = 2013
# min_tags = minumum number of tags that need to be detected for reasonable precision
min_tags = tibble(Species = c('Chinook',
                              'Steelhead'),
                  # min_tags = c(50))
                  min_tags = 45)
                  # min_tags = c(55, 46))
                  # min_tags = c(45, 30))

tags_est_df = pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  filter(spawn_yr >= min_yr) %>%
  # select(spawn_yr, Species, TRT, n_tags) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags_det = n_tags / tot_tags) %>%
  group_by(Species, TRT) %>%
  summarise_at(vars(prop_tags_det),
               list(mean)) %>%
  left_join(min_tags) %>%
  mutate(tot_tags_need = min_tags / prop_tags_det)

# tags_est_df %>%
#   ggplot(aes(x = tot_tags_need)) +
#   geom_histogram(aes(fill = TRT),
#                  bins = 20) +
#   geom_vline(data = tags_deploy %>%
#                filter(spawn_yr >= min_yr) %>%
#                group_by(Species) %>%
#                summarise_at(vars(tot_tags),
#                             list(mean)),
#              aes(xintercept = tot_tags),
#              linetype = 2) +
#   facet_wrap(~ Species,
#              scales = 'free') +
#   scale_fill_viridis_d()
```

```{r, eval = F}
pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  filter(spawn_yr >= min_yr) %>%
  select(spawn_yr, Species, TRT, n_tags) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags_det = n_tags / tot_tags) %>%
  ggplot(aes(x = spawn_yr,
             y = prop_tags_det,
             color = Species)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 0.01,
             linetype = 2,
             color = 'darkgray') +
  scale_color_brewer(palette = 'Set1') +
  facet_wrap(~ Species + TRT)

tags_est_df %>%
  filter(prop_tags_det < 0.01) %>%
  full_join(single_site_pops) %>%
  as.data.frame()


```

## Populations with No Detections

There are a number of TRT populations for both species that currently lack any PIT tag detection infrastructure, and are therefore not represented in DABOM estimates at all. These are listed in Table \@ref(tab:no-monitor-tab), although we recognize that IPTDS have been installed in a small group of these recently (e.g., Marsh Creek).

```{r no-monitor-tab}
no_monitor_pops %>%
  # pander()
  kable(caption = "Populations, by species, with no PIT tag detection infrastructure and therefore which are not accounted for by DABOM.")
```

## Populations with Low Detections

When we initially examined the proportion of all tags deployed at LGR that were detected in each TRT population, by species, we noted a number of populations had very low proportions (e.g., < 2%) of tags observed within them. The low proportion of tags observed within a population can be attributed to three primary reasons:

1. True low spawner abundance.
2. Low detection probability among sites within the population.
3. Detection infrastructure within the population was not intended to monitor natural origin spawner abudance (e.g., hatchery rack detections).

In practice, detection probabilities at instream PIT tag detection systems (IPTDS) intended for natural origin population abundance monitoring have high detection probabilities, so we further examined populations with low proportions of detections and whether that was due to reasons #1 or #3 (or a combination thereof) above. In addition, the proportion of detections within a population was averaged across years, and thus, we considered populations where infrastructure was installed in a later year. Table \@ref(tab:remove-tab)  and the following narrative provide a summary of populations and years we chose to remove from the analysis due to non-existent IPTDS or infrastructure not intended for natural population monitoring. We additionally note some populations with low proportions of detections that we believe to be due to low population size.

```{r remove-tab}
remove_t = read_excel('../data/TRT_Pop_Considerations.xlsx')
  
remove_t %>%
  select(-Notes) %>%
  rename(Sites = SiteIDs) %>%
  mutate_at(vars(`2013`:`2019`),
            list(~ if_else(. == 'Y', 'R', as.character(NA)))) %>%
  kable(caption = "Populations, by species, with a low number of total tags deployed at LGR detected within. These populations were further examined as to whether low detections were due to true low population size or infrastructure not intended for population monitoring. Species, TRT population, and year combinations containing a [R] were removed from analysis because IPTDS did not exist or were not intended for population monitoring.")

rmv = remove_t %>%
  select(-SiteIDs) %>%
  gather(key, value, `2013`:`2019`) %>%
  filter(value == 'Y') %>%
  rename(spawn_yr = key,
         remove = value)

incl_pops = sb_pops %>%
  anti_join(no_monitor_pops) %>%
  anti_join(remove_t %>%
              filter((Species == "Chinook" & `2018` == 'Y') |
                       (Species == "Steelhead" & `2019` == 'Y')) %>%
              select(Species, TRT))
```  

### Chinook

```{r remove-notes-chnk}
remove_t %>%
  filter(Species == 'Chinook') %>%
  select(TRT, Notes) %>%
  kable(caption = 'Reasons for certain Chinook populations being excluded from this analysis.',
        format.args = list(justify = 'left'))
  # pander(style = 'rmarkdown',
  #        justify = 'left')
```

Also note that the GRLOS, GRMIN, GRCAT, and GRUMA Chinook salmon TRT populations all occur above the UGR array; however, we don't know which population an adult is destined for after passing UGR unless it is detected again upstream. As a result, Chinook salmon adults that are last observed at the UGR site cannot be used in population abundance estimates. One might consider how final observations at UGR could be leveraged in the future for upriver abundance estimates.

### Steelhead

```{r remove-notes-sthd}
remove_t %>%
  filter(Species == 'Steelhead') %>%
  # mutate(TRT = str_replace(TRT, '-', '--')) %>%
  # mutate_at(vars(TRT),
  #           list(as.factor)) %>%
  select(TRT, Notes) %>%
  kable(caption = 'Reasons for certain steelhead populations being excluded from this analysis.',
        format.args = list(justify = 'left'))
```

\newpage

# Results

## Number of Tags Required in a TRT Population

Figure \@ref(fig:tags-vs-cv) shows the number of PIT tags detected within a TRT population and the corresponding CV of the population abundance estimate, by species, using results going back to 2013 and after removing population and year combinations in which low/no observations were due to lack of IPTDS or IPTDS not intended for natural origin population abundance (Table \@ref(tab:remove-tab)).

```{r tags-vs-cv, fig.cap = "Scatterplot of the number of PIT tags detected in each population and the CV of the abundance estimates for that population. The lines of semi-log, log-log and loess fits to the data. The dashed horizontal line indicates a CV of 15%."}

pop_est = pop_est %>%
  anti_join(rmv) %>%
  mutate_at(vars(spawn_yr:TRT),
            list(fct_drop))

pop_est %>%
  ggplot(aes(x = n_tags,
             y = cv)) +
  geom_point() +
  scale_color_brewer(palette = 'Set1') + 
  geom_hline(yintercept = 0.15,
             linetype = 2) +
  geom_smooth(aes(color = 'Loess'),
              span = 0.9,
              se = F,
              fullrange = T) +
  geom_smooth(aes(color = 'Semi-log'),
              method = glm,
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  geom_smooth(aes(color = 'Log-log'),
              method = glm,
              formula = y ~ log(x),
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  facet_wrap(~ Species) +
  labs(x = '# PIT Tags Detected',
       y = 'CV of Pop. Est.',
       color = 'Model')
```

Additionally, using the same data, we examined the proportion of total tags deployed at LGR that were observed within a TRT population and the CV of the abundance estimate (Figure \@ref(fig:perc-tags-vs-cv)).

```{r perc-tags-vs-cv, fig.cap = "Scatterplot of the proportion of PIT tags detected in each population and the CV of the abundance estimate for that population. The lines are semi-log, log-log and Loess fits to that data. The dashed horizontal line denotes a CV of 15%."}

pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  left_join(tags_deploy) %>%
  ggplot(aes(x = n_tags / tot_tags,
             y = cv)) +
  geom_point() +
  scale_color_brewer(palette = 'Set1') + 
  geom_hline(yintercept = 0.15,
             linetype = 2) +
  geom_smooth(aes(color = 'Loess'),
              span = 0.9,
              se = F,
              fullrange = T) +
  geom_smooth(aes(color = 'Semi-log'),
              method = glm,
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  geom_smooth(aes(color = 'Log-log'),
              method = glm,
              formula = y ~ log(x),
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  facet_wrap(~ Species) +
  labs(x = '% PIT Tags Detected',
       y = 'CV of Pop. Est.',
       color = 'Model')
```

Ultimately, we were interested in the number of PIT tags that need to be observed within a population or the proportion of total PIT tags deployed at LGR detected within a population necessary to achieve a predicted CV of $\leq$ 0.15 for the abundance estimate. To do this, we tried fitting a separate model for each species, and after fitting those models (semi-log, log-log and loess), we examined the minimum number and proportion of total tags that would need to be detected to achieve that CV level. Those results are shown in Tables \@ref(tab:n-tags-tab) and \@ref(tab:prop-tags-tab).

```{r n-tags-tab}
mod_df = pop_est %>%
  group_by(Species) %>%
  nest() %>%
  mutate(mod_semi_log = map(data,
                      .f = function(x) {
                        glm(cv ~ n_tags,
                            family = gaussian(link = 'log'),
                            data = x)
                      }),
         mod_loess = map(data,
                         .f = function(x) {
                           loess(cv ~ n_tags,
                                 data = x)
                         }),
         mod_log_log = map(data,
                           .f = function(x) {
                           lm(log(cv) ~ log(n_tags),
                              data = x)
                           }))

mod_df %>%
  gather(model, mod_fit, starts_with('mod')) %>%
  mutate(pred = map(.x = mod_fit,
                    .f = function(x) {
                      tibble(n_tags = seq(0, 300)) %>%
                        mutate(pred_cv = predict(x, 
                                                 newdata = .,
                                                 type = 'response'))
                      })) %>%
  select(Species, 
         Model = model, pred) %>%
  mutate(Model = recode(Model,
                        'mod_semi_log' = 'Semi-log',
                        'mod_loess' = 'Loess',
                        'mod_log_log' = 'Log-log')) %>%
  unnest(cols = c(pred)) %>%
  mutate(pred_cv = if_else(Model == 'Log-log',
                           exp(pred_cv),
                           pred_cv)) %>%
  group_by(Species, Model) %>%
  filter(pred_cv <= 0.15) %>%
  slice(1) %>%
  rename(`# Tags` = n_tags,
         `Pred. CV` = pred_cv) %>%
  kable(caption = "Estimated number of PIT tags that need to be detected within a TRT population to achieve a CV of 15% or less for abundance estimates.",
        digits = 3)

```  

```{r prop-tags-tab}
prop_mod_df = pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags = n_tags / tot_tags) %>%
  group_by(Species) %>%
  nest() %>%
  mutate(mod_semi_log = map(data,
                      .f = function(x) {
                        glm(cv ~ prop_tags,
                            family = gaussian(link = 'log'),
                            data = x)
                      }),
         mod_loess = map(data,
                         .f = function(x) {
                           loess(cv ~ prop_tags,
                                 data = x)
                         }),
         mod_log_log = map(data,
                           .f = function(x) {
                           lm(log(cv) ~ log(prop_tags),
                              data = x)
                           }))

prop_mod_df %>%
  gather(model, mod_fit, starts_with('mod')) %>%
  mutate(pred = map(.x = mod_fit,
                    .f = function(x) {
                      tibble(prop_tags = seq(0, 0.5, by = 0.001)) %>%
                        mutate(pred_cv = predict(x, 
                                                 newdata = .,
                                                 type = 'response'))
                      })) %>%
  select(Species, 
         Model = model, pred) %>%
  mutate(Model = recode(Model,
                        'mod_semi_log' = 'Semi-log',
                        'mod_loess' = 'Loess',
                        'mod_log_log' = 'Log-log')) %>%
  unnest(cols = c(pred)) %>%
  mutate(pred_cv = if_else(Model == 'Log-log',
                           exp(pred_cv),
                           pred_cv)) %>%
  group_by(Species, Model) %>%
  filter(pred_cv <= 0.15) %>%
  slice(1) %>%
  mutate(prop_tags = paste(round(prop_tags, 3) * 100, '%')) %>%
  rename(`% Tags Detected` = prop_tags,
         `Pred. CV` = pred_cv) %>%
  kable(caption = "The estimated proportion of total tags deployed at LGR that need to be detected within a TRT population to achieve a CV of 15% or less for abundance estimates.",
        digits = 3)

```  

Table \@ref(tab:n-tags-tab) shows that we need to detect about 45-55 Chinook salmon and 30-46 steelhead to achieve a CV of 15% or less for natural origin abundance estimates. Further, Table \@ref(tab:prop-tags-tab) shows that, using past results, we need to detect about 2-3% of Chinook salmon or about 1% of steelhead PIT tags deployed at LGR within a population to achieve reasonably precise estimates of abundance. Looking at model diagnostics (not shown), the log-log model appears to meet the linear model assumptions the best. For the sake of simplicity, let's assume that we need to detect `r unique(min_tags$min_tags)` PIT tags within a population, for both species, to achieve a precise abundance estimate (Figure \@ref(fig:tag50)).

```{r tag50, eval = T, fig.height = 6, fig.cap = "The number of PIT tags detected in a TRT population and the corresponding population abundance estimate, by species, using results back to spawn year 2013. Estimates shown in blue had a CV of 15% or less. The dashed vertical line denotes 45 PIT tags detected."}
pop_est %>%
  ggplot(aes(x = n_tags,
             y = mean)) +
  geom_point(aes(color = cv <= 0.15)) +
  scale_color_brewer(palette = 'Set1') + 
  facet_wrap(~ Species) +
  geom_vline(xintercept = unique(min_tags$min_tags),
             linetype = 2) +
  labs(x = '# PIT Tags Detected',
       y = 'Pop. Est.',
       color = 'Acceptable\nPrecision')
```

### Sex and Age Estimates

We want to note that reasonably precise estimates of abundance, by sex and total age, are also a desired outcome as they are necessary to construct brood tables and estimate population productivity. However, note that it will not require `r unique(min_tags$min_tags)` female tags detected within a population to achieve reasonable precision of female abundance. Rather, we will take the total abundance estimate to a TRT population and multiply it by a binomial (female vs. male) proportion to generate abundance by females and males. The binomial proportions will be estimated from all of the tags detected in that TRT population. If we have about `r unique(min_tags$min_tags)` total tags detected in a population for a good abundance estimate, the proportion female or male will be fairly precise because `r unique(min_tags$min_tags)` is a good sample size for proportions, especially when the proportion is somewhere near 50%. Therefore, the CV for the number of females in that population will be slightly larger than the CV of the total abundance, but probably not by much. 

Similar arguments hold for abundance by total age (multinomial proportions), although as we attempt to account for more age classses, the precision will suffer. Therefore, for a Chinook salmon population with 3 total age classes, we expect to get reasonable estimates with a sample size close to `r unique(min_tags$min_tags)`. However, for a steelhead population with up to 6 or so total age classes, the precision will suffer, especially since some of the total age classes may have very few fish. However, sex and age classes with proportions outside the tails (e.g., > 10%) would likely have good precision.

## Total Tags at Lower Granite

We now have an estimate of the number of PIT tags that need to be detected within a TRT population (`r unique(min_tags$min_tags)`) to achieve an abundance estimate with reasonable precision. But now we want to know how many PIT tags would need to be deployed at LGR to observe `r unique(min_tags$min_tags)` PIT tags within any population. The proportion of all PIT tags deployed at LGR that were detected in any TRT population has changed over time, due to more IPTDS infrastructure being installed across the Snake River Basin (Figure \@ref(fig:prop-black-box)), and thus, we chose to focus on the period from `r min_yr` on, since the infrastructure has been more stable since then. Since `r min_yr`, the average proportion of all tags deployed from LGR that were detected in a TRT population, by species, is shown in Table \@ref(tab:prop-det-tab).

```{r prop-black-box, fig.cap = "The proportion of all PIT tags deployed at LGR that were later detected within a TRT population each year, by species."}
prop_det_df %>%
  ggplot(aes(x = spawn_yr,
             y = prop_det,
             color = Species)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette = 'Set1') +
  scale_x_continuous(breaks = pretty_breaks()) +
  labs(x = 'Spawn Year',
       y = 'Proportion Tags Detected after LGR',
       color = 'Species')
```

```{r prop-det-tab}
prop_det_df %>%
  filter(spawn_yr >= min_yr) %>%
  group_by(Species) %>%
  summarise_at(vars(prop_det),
               list(mean)) %>%
  mutate_at(vars(prop_det),
            list(~ paste(round(., 3) * 100, "%"))) %>%
  rename(`Avg. % Total Tags Detected` = prop_det) %>%
  # clean_names(case = 'upper_camel') %>%
  kable(caption = "The average proportion of tags deployed at LGR detected in a TRT population since 2013, by species.")
```

Next, Table \@ref(tab:lgr-tags-needed) summarizes the total number of tags that would need to be deployed at LGR to achieve a precise abundance estimate for any given TRT population. Again, Table \@ref(tab:lgr-tags-needed) only contains TRT populations that contain infrastructure intended for natural origin population abundance monitoring, and within populations, years in which IPTDS were not installed were excluded (Table \@ref(tab:remove-tab)).

```{r lgr-tags-needed}
tags_tables = tags_est_df %>%
  left_join(site_pop %>%
              select(Species, TRT, Name = POP_NAME) %>%
              distinct()) %>%
  select(Species, TRT, Name, everything()) %>%
  anti_join(rmv %>%
              filter(remove == 'Y') %>%
              select(Species, TRT) %>%
              distinct()) %>%
  arrange(Species, desc(tot_tags_need)) %>%
  mutate_at(vars(min_tags, tot_tags_need),
            list(as.integer)) %>%
  rename(`% Tags Detected` = prop_tags_det,
         `Min. # Tags` = min_tags,
         `Total Tags Needed` = tot_tags_need) %>%
  split(list(.$Species))

tags_tables[[1]] %>%
  kable(caption = "The expected number of tags needed to be deployed at LGR to achieve a minimum number of detections in each TRT population leading to reasonably precise estimate of abundance.",
        digits = 3,
        format.args = list(big.mark = ','))

tags_tables[[2]] %>%
  kable(digits = 3,
        format.args = list(big.mark = ','))
```

Finally, we summarised results by examining the percentage of TRT population abundance estimates we would expect to be reasonably precise (i.e. CV $\leq$ 0.15) given a certain number of tags deployed at LGR (Figure \@ref(fig:perc-good-CV)). Results were similar for each species. As an example, if 2,000 PIT tags were deployed for each species at LGR, we might expect that approximately 40% of TRT population abundance estimates would have a CV of 15% or less (Figures \@ref(fig:perc-good-CV) and \@ref(fig:perc-good-CV-zoom)); with 4,000 PIT tags per species, we'd expect that about 75% of monitored Chinook salmon and 62% of monitored steelhead population abundance estimates would be reasonably precise. 

Another way to interpret Figure \@ref(fig:perc-good-CV) is to see which TRT populations would or would not be expected to have a reasonably precise abundance estimate for a given number of tags. For example, if 4,000 spring/summer Chinook were tagged, we could expect reasonable abundance estimates for all populations except SRYFS, CRLOL and IRBSH. Figure \@ref(fig:perc-good-CV-zoom) provides the same information as Figure \@ref(fig:perc-good-CV), except is zoomed into the lower-left portion of the plot to focus on lower numbers of tags deployed.

```{r}
prop_trt_df = tags_est_df %>%
  ungroup() %>%
  mutate(tot_tags_need_05 = prop_tags_det * 1.05,
         tot_tags_need_10 = prop_tags_det * 1.1,
         tot_tags_need_20 = prop_tags_det * 1.20) %>%
  mutate_at(vars(tot_tags_need_05:tot_tags_need_20),
            list(~ min_tags / .)) %>%
  select(Species, TRT, starts_with("tot_tags_need")) %>%
  anti_join(rmv %>%
              filter(remove == 'Y') %>%
              select(Species, TRT) %>%
              distinct()) %>%
  gather(scenario, tot_tags_need, starts_with("tot_tags_need")) %>%
  mutate(scenario = recode(scenario,
                           'tot_tags_need' = 'Current'),
         scenario = str_replace(scenario,
                                'tot_tags_need_', 
                                'Increase p by ')) %>%
  crossing(tot_tags_deploy = seq(500, 20000, by = 100)) %>%
  mutate(sufficient = if_else(tot_tags_deploy >= tot_tags_need,
                              T, F)) %>%
  filter(sufficient) %>%
  group_by(Species, scenario, TRT) %>%
  filter(tot_tags_deploy == min(tot_tags_deploy)) %>%
  # filter(scenario == 'Current') %>%
  group_by(Species, scenario, tot_tags_deploy) %>%
  summarise(n_trt = n_distinct(TRT),
            which_trt = paste(TRT, collapse = ', ')) %>%
  ungroup() %>%
  left_join(tags_est_df %>%
              anti_join(rmv) %>%
              group_by(Species) %>%
              summarise(tot_trt = n_distinct(TRT))) %>%
  group_by(Species, scenario) %>%
  mutate(cum_trt = cumsum(n_trt),
         prop_trt = cum_trt / tot_trt) %>%
  ungroup()
```


```{r perc-good-CV, fig.height = 7, fig.cap = "Expected proportion of TRT populations with a good CV of abundance estimates for a given number of PIT tags deployed at LGR, faceted by species. Dashed line shows 4,000 tags. Labels depict which additional TRT populations are expected to have a good CV of abundance as the number of tags deployed increases."}
prop_trt_p = prop_trt_df %>%
  filter(scenario == 'Current') %>%
  ggplot(aes(x = tot_tags_deploy,
             y = prop_trt)) +
  geom_point() + 
  geom_step() +
  geom_vline(xintercept = 4000,
             linetype = 2) +
  geom_label_repel(aes(label = which_trt),
                   show.legend = F,
                   force = 2,
                   size = 3) +
  facet_wrap(~ Species,
             ncol = 1) +
  labs(x = '# Tags Deployed at Lower Granite',
       y = expression(paste("Proportion of Monitored TRT Populations with Precise ", hat(N))))

prop_trt_p
```

```{r perc-good-CV-zoom, fig.height = 7, fig.cap = "Same as figure above, but zoomed into the lower left corner of that plot."}
prop_trt_p +
  scale_x_continuous(limits = c(0, 6000))
```

One way to increase the number of tags detected in a given population is to increase the total number of tags deployed at LGR, but another could be to increase the probability of detecting a tag assuming it does arrive in that population. This could be done by upgrading older in-stream PIT tag detection equipment, re-deploying it more effectively, or adding detection sites within the population. Without exploring specific ways that detection efficiency could be increased within each population (or even whether it could be increased by the amounts suggested) we evaluated the potential effect on the number of total tags needed to be deployed at Lower Granite if the detection probability was increased by 5, 10 or 20% across the basin. 

Figure \@ref(fig:good-cv-det-fig) shows how such increases would impact the number of tags needed to be deployed. The main message from this analysis is that improving detection efficiency, even by as much as 20% (which is actually impossible in most populations, as that would increase it to above 100%), does not reduce the number of tags needed very much. This is partly due to the fact that most populations already have high detection efficiency. However, there may be certain populations where improving the detection infrastructure could lead to gains in the precision of the abundance estimate. Figure \@ref(fig:det-prob-fig) summarizes detection probabilities, by population and MPG/DPS, and could be used to provide guidance on populations/areas where IPTDS infrasructure could be best increased or improved.

```{r good-cv-det-fig, fig.height = 7, fig.cap = "Expected proportion of TRT populations with a good CV of abundance estimates for a given number of PIT tags deployed at LGR, faceted by species, colored by detection probability scenario."}

# prop_trt_df %>%
#   arrange(desc(prop_trt))

prop_trt_df %>%
  mutate(scenario = str_replace(scenario,
                                '05', '5%'),
         scenario = str_replace(scenario,
                                '10', '10%'),
         scenario = str_replace(scenario,
                                '20', '20%'),
         scenario = as.factor(scenario),
         scenario = fct_relevel(scenario,
                                'Increase p by 5%',
                                after = 1)) %>%
  ggplot(aes(x = tot_tags_deploy,
             y = prop_trt,
             color = scenario)) +
  geom_point() + 
  geom_step() +
  # geom_label_repel(aes(label = which_trt),
  #                  show.legend = F,
  #                  force = 2,
  #                  size = 3) +
  scale_color_viridis_d(name = 'Scenario',
                        end = 0.8) +
  facet_wrap(~ Species,
             ncol = 1) +
  labs(x = '# Tags Deployed at Lower Granite',
       y = expression(paste("Proportion of Monitored TRT Populations with Precise ", hat(N))))

```

```{r det-prob-fig, fig.height = 7, fig.cap = "Histograms of detection probabilities at each array, estimated from DABOM, facted by MPG and colored by TRT population."}
# determine which populations don't have good detection infrastructure to make estimates
p_mpg_list = p_est %>%
  anti_join(rmv) %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  # filter(spawn_yr >= min_yr) %>%
  # filter(spawn_yr >= 2013) %>%
  filter(n_tags > 0,
         estimate > 0,
         sd > 0,
         !is.na(TRT)) %>%
  group_by(Species, Node, TRT, POP_NAME, MPG) %>%
  summarise_at(vars(estimate),
               list(mean)) %>%
  ungroup() %>%
  split(list(.$Species)) %>%
  map(.f = function(x) {
    x %>%
      mutate_at(vars(TRT, MPG),
                list(fct_drop)) %>%
      ggplot(aes(x = estimate,
                 fill = TRT)) +
      geom_histogram(binwidth = 0.05) +
      facet_wrap(~ MPG,
                 scales = 'free_y') +
      scale_fill_viridis_d() +
      labs(x = 'Detection Probability',
           title = unique(x$Species))
  })

ggpubr::ggarrange(plotlist = p_mpg_list,
                  ncol = 1,
                  nrow = 2)
```

# Conclusions

There are `r sum(sb_pops$Species[sb_pops$Status == 'Extant'] == 'Chinook')` extant Chinook salmon populations in the Snake River; of those, `r nrow(tags_tables[[1]])` contain IPTDS used to monitor natural origin population abundance. For steelhead, there are `r sum(sb_pops$Species[sb_pops$Status == 'Extant'] == 'Steelhead')` of which `r nrow(tags_tables[[2]])` contain IPTDS to monitor spawner abundance. Our results suggest we need to detect a minimum of about `r unique(min_tags$min_tags)` tags per TRT population to achieve acceptable precision in our abundance estimates at the TRT spatial scale. Figures \@ref(fig:perc-good-CV) and \@ref(fig:perc-good-CV-zoom) can be interpreted to mean that assuming any given TRT population contains IPTDS intended for population monitoring and 4,000 PIT tags are deployed at LGR, we'd expect that about 75% (Chinook) and 60% (steelhead) of TRT populations monitored with PIT tags would have abundance estimates with "good" precision (i.e. CV $\leq$ 0.15).  
